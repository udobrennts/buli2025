<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Bundesliga Tippspiel – Online Live-Scorer (hardened)</title>
<meta name="description" content="Robuster Live-Scorer für Bundesliga-Tipps mit vielen CORS-Fallbacks und Debug-Konsole.">
<style>
  :root { --bg:#0b0f14; --card:#121826; --muted:#94a3b8; --ok:#16a34a; --bad:#ef4444; --accent:#38bdf8; }
  * { box-sizing:border-box; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
  body { margin:0; background:var(--bg); color:#e5e7eb; }
  header { padding:18px 20px; border-bottom:1px solid #1f2937; display:flex; flex-wrap:wrap; gap:12px; align-items:baseline;}
  h1 { margin:0; font-size:1.2rem; }
  .muted { color:var(--muted); }
  main { padding:18px; max-width:1100px; margin:0 auto; }
  .controls { display:flex; flex-wrap:wrap; gap:10px; align-items:center; margin-bottom:12px; }
  select, button { background:#0f172a; color:#e5e7eb; border:1px solid #1f2937; padding:8px 10px; border-radius:10px; }
  button { cursor:pointer; }
  .board { background:var(--card); border:1px solid #1f2937; border-radius:14px; padding:14px; box-shadow:0 6px 24px rgba(0,0,0,.25); }
  table { width:100%; border-collapse:collapse; font-size:14px; }
  thead th { text-align:left; color:#cbd5e1; font-weight:600; border-bottom:1px solid #1f2937; padding:10px 8px; white-space:nowrap; position:sticky; top:0; background:var(--card); z-index:2; }
  tbody td { padding:8px; border-bottom:1px dashed #243244; vertical-align:middle; }
  tbody tr:hover { background: rgba(255,255,255,.03); }
  .rank { width:36px; font-variant-numeric: tabular-nums; }
  .club { display:flex; align-items:center; gap:10px; }
  .club img { width:22px; height:22px; border-radius:50%; background:#111827; }
  .chip { display:inline-block; padding:2px 8px; border-radius:999px; font-variant-numeric:tabular-nums; }
  .good { background:rgba(22,163,74,.15); color:var(--ok); }
  .bad  { background:rgba(239,68,68,.15); color:var(--bad); }
  .exact { border:1px solid var(--ok); }
  .sum { font-weight:700; }
  .kpis { display:flex; gap:12px; margin:12px 0 18px; }
  .kpis > div { background:var(--card); border:1px solid #1f2937; border-radius:12px; padding:10px 12px; }
  .kpiLabel { color:var(--muted); font-size:.85rem; }
  .kpiValue { font-size:1.05rem; color:#fff; }
  .msg { margin:6px 0 12px; }
  a { color: var(--accent); }
  footer { color:var(--muted); padding:8px 20px 20px; font-size:.85rem; }
  details { margin-top: 12px; }
  pre { background:#0f172a; border:1px solid #1f2937; border-radius:10px; padding:10px; white-space:pre-wrap; overflow:auto; }
</style>
</head>
<body>
  <header>
    <h1>Bundesliga Tippspiel – Online Live-Scorer</h1>
    <div class="muted">Regel: |Tipp − Live-Platz|, Summe = Minuspunkte (weniger ist besser). Einsatz: 1× Polvo-Essen.</div>
  </header>
  <main>
    <div class="controls">
      <label>Saison:
        <select id="season">
          <option value="2025" selected>2025</option>
          <option value="2024">2024</option>
          <option value="">(aktuell, falls unterstützt)</option>
        </select>
      </label>
      <label>Sortieren:
        <select id="sorter">
          <option value="live">Live-Platz</option>
          <option value="thomas">Thomas’ Tipp</option>
          <option value="dave">Daves Tipp</option>
          <option value="diff_thomas">Δ Thomas</option>
          <option value="diff_dave">Δ Dave</option>
          <option value="name">Teamname</option>
        </select>
      </label>
      <button id="reload">Neu laden</button>
    </div>

    <div id="msg" class="msg muted"></div>

    <div class="board">
      <table id="table">
        <thead><tr>
          <th class="rank">#</th>
          <th>Team</th>
          <th>Live</th>
          <th>Thomas</th>
          <th>Δ Thomas</th>
          <th>Dave</th>
          <th>Δ Dave</th>
        </tr></thead>
        <tbody></tbody>
        <tfoot><tr class="sum">
          <td></td><td>Summe Minuspunkte</td>
          <td></td>
          <td id="sum_thomas"></td><td></td>
          <td id="sum_dave"></td><td></td>
        </tr></tfoot>
      </table>
    </div>

    <div class="kpis">
      <div><div class="kpiLabel">Thomas</div><div class="kpiValue" id="kpi_thomas">–</div></div>
      <div><div class="kpiLabel">Dave</div><div class="kpiValue" id="kpi_dave">–</div></div>
      <div><div class="kpiLabel">Führend</div><div class="kpiValue" id="leader">–</div></div>
    </div>

    <details>
      <summary>Debug</summary>
      <div id="debug"></div>
    </details>
  </main>

  <footer>
    <div>Quelle: OpenLigaDB. Viele CORS-Fallbacks und Seasons. Bei Bedarf Saison wechseln und „Neu laden“.</div>
  </footer>

<script>
const teamsOfficial = [
  "FC Bayern München","Borussia Dortmund","RB Leipzig","VfB Stuttgart",
  "Bayer 04 Leverkusen","Eintracht Frankfurt","1. FSV Mainz 05","1. FC Köln",
  "FC Augsburg","SV Werder Bremen","SC Freiburg","Borussia Mönchengladbach",
  "TSG 1899 Hoffenheim","VfL Wolfsburg","Hamburger SV","1. FC Union Berlin",
  "FC St. Pauli","1. FC Heidenheim 1846"
];

const picksThomas = {"FC Bayern München":1,"Borussia Dortmund":2,"RB Leipzig":3,"VfB Stuttgart":4,"Bayer 04 Leverkusen":5,"Eintracht Frankfurt":6,"1. FSV Mainz 05":7,"1. FC Köln":8,"FC Augsburg":9,"SV Werder Bremen":10,"SC Freiburg":11,"Borussia Mönchengladbach":12,"TSG 1899 Hoffenheim":13,"VfL Wolfsburg":14,"Hamburger SV":15,"1. FC Union Berlin":16,"FC St. Pauli":17,"1. FC Heidenheim 1846":18};
const picksDave   = {"FC Bayern München":1,"Eintracht Frankfurt":2,"Borussia Dortmund":3,"VfB Stuttgart":4,"Bayer 04 Leverkusen":5,"RB Leipzig":6,"1. FC Köln":7,"1. FSV Mainz 05":8,"SC Freiburg":9,"Hamburger SV":10,"TSG 1899 Hoffenheim":11,"Borussia Mönchengladbach":12,"FC Augsburg":13,"1. FC Heidenheim 1846":14,"VfL Wolfsburg":15,"FC St. Pauli":16,"1. FC Union Berlin":17,"SV Werder Bremen":18};
// Eigener CORS-Proxy (Cloudflare Worker):
const WORKER = "https://udobrennts.davidwstrassbuger.workers.dev/";

function debug(line) {
  const box = document.getElementById("debug");
  const el = document.createElement("pre");
  el.textContent = line;
  box.appendChild(el);
}

function msg(text, cls="muted") {
  const el = document.getElementById("msg");
  el.className = "msg " + cls;
  el.textContent = text;
}

function urlsFor(league, season) {
  const seasons = [];
  if (season !== undefined) seasons.push(season);
  seasons.push("2025","2024","");   // Auswahl → 2025 → 2024 → (aktuell)
  const uniq = [...new Set(seasons)];

  const bases = [
    // 1) Dein Worker zuerst (CORS sicher)
    (s) => `${WORKER}/getbltable/${league}${s ? "/" + s : ""}`,
    // 2) Direkte Quellen nur als Fallbacks
    (s) => `https://api.openligadb.de/getbltable/${league}${s ? "/" + s : ""}`,
    (s) => `https://www.openligadb.de/api/getbltable/${league}${s ? "/" + s : ""}`,
  ];

  const urls = [];
  for (const s of uniq) {
    for (const make of bases) {
      const direct = make(s);
      urls.push(direct);

      // Zusätzliche Fallback-Proxys nur für die direkten Quellen (Worker braucht das nicht)
      if (!direct.startsWith(WORKER)) {
        const enc = encodeURIComponent(direct);
        urls.push(`https://api.allorigins.win/raw?url=${enc}`);
        urls.push(`https://api.allorigins.win/get?url=${enc}`);
        urls.push(`https://cors.isomorphic-git.org/${direct}`);
        urls.push(`https://r.jina.ai/${direct}`);
      }
    }
  }
  return urls;
}


async function fetchCandidate(u) {
  try {
    const res = await fetch(u, { cache: "no-store" });
    if (!res.ok) throw new Error("HTTP " + res.status);
    const ct = res.headers.get("content-type") || "";
    const txt = await res.text();
    // AllOrigins /get returns JSON with {contents: "..."}
    if (u.includes("allorigins.win/get?")) {
      const outer = JSON.parse(txt);
      const inner = outer.contents || outer.contentsText || outer.data || "";
      const data = JSON.parse(inner);
      return data;
    }
    // Otherwise parse raw JSON
    const data = JSON.parse(txt);
    return data;
  } catch (e) {
    debug(`[FAIL] ${u}\\n${e && e.message ? e.message : e}`);
    throw e;
  }
}

async function fetchWithManyFallbacks(league, season) {
  const list = urlsFor(league, season);
  let lastErr = null;
  for (const u of list) {
    try {
      debug(`[TRY ] ${u}`);
      const data = await fetchCandidate(u);
      debug(`[OK  ] ${u} -> ${Array.isArray(data) ? data.length : 'obj'}`);
      return { data, used: u };
    } catch (e) {
      lastErr = e;
    }
  }
  throw lastErr || new Error("Keine Daten von allen Kandidaten.");
}

function toRows(data) {
  return data.map((row, idx) => ({
    pos: idx + 1,
    team: row.TeamName,
    logo: row.TeamIconUrl || "",
    points: row.Points,
    matches: row.Matches,
    goalDiff: row.GoalDiff
  }));
}

function compute(list) {
  let sumT = 0, sumD = 0;
  const enriched = teamsOfficial.map(team => {
    const liveRow = list.find(r => r.team === team) || null;
    const live = liveRow ? liveRow.pos : null;
    const th = picksThomas[team] ?? null;
    const dv = picksDave[team] ?? null;
    const dT = (live !== null && th !== null) ? Math.abs(th - live) : null;
    const dD = (live !== null && dv !== null) ? Math.abs(dv - live) : null;
    if (dT !== null) sumT += dT;
    if (dD !== null) sumD += dD;
    return { team, live, thomas: th, dave: dv, diff_thomas: dT, diff_dave: dD, logo: liveRow ? liveRow.logo : "" };
  });
  return { rows: enriched, sumT, sumD, canScore: enriched.every(r => typeof r.live === "number") };
}

function chip(value) {
  if (value === null || value === undefined) return "<span class='chip bad'>–</span>";
  const cls = value === 0 ? "chip good exact" : "chip " + (value <= 2 ? "good" : "bad");
  return `<span class="${cls}">${value}</span>`;
}

function render(result) {
  const { rows, sumT, sumD, canScore } = result;
  const sorter = document.getElementById("sorter").value;
  const tbody = document.querySelector("#table tbody");
  tbody.innerHTML = "";

  const sorted = rows.slice().sort((a,b)=>{
    if (sorter === "name") return a.team.localeCompare(b.team);
    return (a[sorter] ?? 999) - (b[sorter] ?? 999);
  });

  for (const r of sorted) {
    const rank = (typeof r.live === "number") ? r.live : "–";
    tbody.insertAdjacentHTML("beforeend", `
      <tr>
        <td class="rank">${rank}</td>
        <td class="club"><img src="${r.logo}" alt="" /> ${r.team}</td>
        <td>${rank}</td>
        <td>${r.thomas ?? "–"}</td>
        <td>${chip(r.diff_thomas)}</td>
        <td>${r.dave ?? "–"}</td>
        <td>${chip(r.diff_dave)}</td>
      </tr>
    `);
  }

  document.getElementById("sum_thomas").textContent = canScore ? sumT : "–";
  document.getElementById("sum_dave").textContent   = canScore ? sumD : "–";
  document.getElementById("kpi_thomas").textContent = canScore ? sumT : "–";
  document.getElementById("kpi_dave").textContent   = canScore ? sumD : "–";
  document.getElementById("leader").textContent     = canScore ? ((sumT < sumD) ? "Thomas führt" : (sumD < sumT) ? "Dave führt" : "Gleichstand") : "Live nötig";
}

async function load() {
  const season = document.getElementById("season").value;
  msg("Lade Live-Tabelle …");
  document.getElementById("debug").innerHTML = "";
  try {
    const out = await fetchWithManyFallbacks("bl1", season);
    const rows = toRows(out.data);
    render(compute(rows));
    msg("Live-Daten geladen. Quelle: " + out.used);
    debug("Quelle: " + out.used);
  } catch (e) {
    msg("Konnte Live-Daten nicht laden. Siehe Debug-Details unten. Du kannst Saison wechseln und „Neu laden“ drücken.", "muted");
    render(compute([]));
    debug("Finaler Fehler: " + (e && e.message ? e.message : e));
  }
}

document.getElementById("reload").onclick = load;
document.getElementById("season").onchange = load;
document.getElementById("sorter").onchange = () => load();

load();
</script>

</body>
</html>

