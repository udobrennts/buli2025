<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Bundesliga Tippspiel â€“ Online Live-Scorer</title>
<style>
  body { margin:0; background:#0b0f14; color:#e5e7eb; font-family:system-ui, sans-serif; }
  header { padding:18px 20px; border-bottom:1px solid #1f2937; }
  h1 { margin:0; font-size:1.2rem; }
  main { padding:18px; max-width:1100px; margin:0 auto; }
  .controls { display:flex; gap:10px; flex-wrap:wrap; margin-bottom:12px; }
  select, button { background:#0f172a; color:#e5e7eb; border:1px solid #1f2937; padding:8px 10px; border-radius:10px; }
  button { cursor:pointer; }
  .board { background:#121826; border:1px solid #1f2937; border-radius:14px; padding:14px; }
  table { width:100%; border-collapse:collapse; font-size:14px; }
  thead th { text-align:left; color:#cbd5e1; border-bottom:1px solid #1f2937; padding:8px; }
  tbody td { padding:8px; border-bottom:1px dashed #243244; }
  tbody tr:hover { background:rgba(255,255,255,.03); }
  .rank { width:36px; }
  .chip { padding:2px 8px; border-radius:999px; }
  .good { background:rgba(22,163,74,.15); color:#16a34a; }
  .bad  { background:rgba(239,68,68,.15); color:#ef4444; }
  .kpis { display:flex; gap:12px; margin:12px 0; }
  .kpis > div { background:#121826; border:1px solid #1f2937; border-radius:12px; padding:10px 12px; }
  .kpiLabel { color:#94a3b8; font-size:.85rem; }
  .kpiValue { font-size:1.05rem; }
  details { margin-top:14px; }
  #debug { font-family:ui-monospace, monospace; white-space:pre-wrap; }
</style>
</head>
<body>
<header>
  <h1>Bundesliga Tippspiel â€“ Online Live-Scorer</h1>
  <div>Regel: |Tipp âˆ’ Live-Platz|, Summe = Minuspunkte. Einsatz: 1Ã— Polvo-Essen.</div>
</header>
<main>
  <div class="controls">
    <label>Saison:
      <select id="season">
        <option value="2025" selected>2025</option>
        <option value="2024">2024</option>
      </select>
    </label>
    <label>Sortieren:
      <select id="sorter">
        <option value="live">Live-Platz</option>
        <option value="thomas">Thomas</option>
        <option value="dave">Dave</option>
        <option value="diff_thomas">Î” Thomas</option>
        <option value="diff_dave">Î” Dave</option>
        <option value="name">Teamname</option>
      </select>
    </label>
    <button id="reload">Neu laden</button>
  </div>

  <div class="board">
    <table id="table">
      <thead><tr>
        <th>#</th><th>Team</th><th>Live</th>
        <th>Thomas</th><th>Î” Thomas</th>
        <th>Dave</th><th>Î” Dave</th>
      </tr></thead>
      <tbody></tbody>
      <tfoot><tr>
        <td></td><td>Summe</td><td></td>
        <td id="sum_thomas"></td><td></td>
        <td id="sum_dave"></td><td></td>
      </tr></tfoot>
    </table>
  </div>

  <div class="kpis">
    <div><div class="kpiLabel">Thomas</div><div class="kpiValue" id="kpi_thomas">â€“</div></div>
    <div><div class="kpiLabel">Dave</div><div class="kpiValue" id="kpi_dave">â€“</div></div>
    <div><div class="kpiLabel">FÃ¼hrend</div><div class="kpiValue" id="leader">â€“</div></div>
  </div>

  <details open>
    <summary>Debug</summary>
    <div id="debug"></div>
  </details>
</main>

<script>
// ðŸ‘‰ Deine Worker-URL hier:
const WORKER = "https://udobrennts.davidwstrassbuger.workers.dev";

// Teams + Tipps
const teamsOfficial = ["FC Bayern MÃ¼nchen","Borussia Dortmund","RB Leipzig","VfB Stuttgart","Bayer 04 Leverkusen","Eintracht Frankfurt","1. FSV Mainz 05","1. FC KÃ¶ln","FC Augsburg","SV Werder Bremen","SC Freiburg","Borussia MÃ¶nchengladbach","TSG 1899 Hoffenheim","VfL Wolfsburg","Hamburger SV","1. FC Union Berlin","FC St. Pauli","1. FC Heidenheim 1846"];
const picksThomas = {"FC Bayern MÃ¼nchen":1,"Borussia Dortmund":2,"RB Leipzig":3,"VfB Stuttgart":4,"Bayer 04 Leverkusen":5,"Eintracht Frankfurt":6,"1. FSV Mainz 05":7,"1. FC KÃ¶ln":8,"FC Augsburg":9,"SV Werder Bremen":10,"SC Freiburg":11,"Borussia MÃ¶nchengladbach":12,"TSG 1899 Hoffenheim":13,"VfL Wolfsburg":14,"Hamburger SV":15,"1. FC Union Berlin":16,"FC St. Pauli":17,"1. FC Heidenheim 1846":18};
const picksDave   = {"FC Bayern MÃ¼nchen":1,"Eintracht Frankfurt":2,"Borussia Dortmund":3,"VfB Stuttgart":4,"Bayer 04 Leverkusen":5,"RB Leipzig":6,"1. FC KÃ¶ln":7,"1. FSV Mainz 05":8,"SC Freiburg":9,"Hamburger SV":10,"TSG 1899 Hoffenheim":11,"Borussia MÃ¶nchengladbach":12,"FC Augsburg":13,"1. FC Heidenheim 1846":14,"VfL Wolfsburg":15,"FC St. Pauli":16,"1. FC Union Berlin":17,"SV Werder Bremen":18};

// Debug immer offen
function debug(line){
  console.log(line);
  const box = document.getElementById("debug");
  const el = document.createElement("div");
  el.textContent = String(line);
  box.appendChild(el);
}
window.addEventListener("error", e => debug("[JS ERROR] " + e.message));
window.addEventListener("unhandledrejection", e => debug("[PROMISE REJECTION] " + (e.reason?.message||e.reason)));

// Kleine Helfer
function chip(v){ if(v==null) return "<span class='chip bad'>â€“</span>"; return `<span class="chip ${v===0?"good":"bad"}">${v}</span>`; }
function deUmlaut(s){return s.replace(/Ã¤/g,"ae").replace(/Ã¶/g,"oe").replace(/Ã¼/g,"ue").replace(/ÃŸ/g,"ss").replace(/Ã„/g,"Ae").replace(/Ã–/g,"Oe").replace(/Ãœ/g,"Ue");}
function norm(s){return deUmlaut(String(s||"")).toLowerCase().replace(/[^a-z0-9]+/g," ").trim();}
function lev(a,b){a=a||"";b=b||"";const m=a.length,n=b.length,dp=Array.from({length:m+1},()=>Array(n+1).fill(0));for(let i=0;i<=m;i++)dp[i][0]=i;for(let j=0;j<=n;j++)dp[0][j]=j;for(let i=1;i<=m;i++){for(let j=1;j<=n;j++){const cost=a[i-1]===b[j-1]?0:1;dp[i][j]=Math.min(dp[i-1][j]+1,dp[i][j-1]+1,dp[i-1][j-1]+cost);}}return dp[m][n];}

// Synonyme
const synonymList = {"borussia moenchengladbach":["gladbach","bmg"],"rasenballsport leipzig":["rb leipzig","leipzig"],"bayer 04 leverkusen":["leverkusen","b04"],"eintracht frankfurt":["frankfurt","sge"],"1 fc koeln":["koeln","fc koeln","koln"],"1 fsv mainz 05":["mainz","fsv mainz"],"sv werder bremen":["werder","bremen"],"1 fc union berlin":["union","union berlin"],"fc st pauli":["st pauli","st. pauli"],"1 fc heidenheim 1846":["heidenheim"],"hamburger sv":["hsv","hamburg"],"borussia dortmund":["dortmund","bvb"],"fc bayern muenchen":["bayern","fcb"]};

// URL-Kandidaten
function urlsFor(league, season){
  const seasons=[season,"2025","2024",""];
  const uniq=[...new Set(seasons)];
  const t=Date.now();
  return uniq.map(s=>`${WORKER}/getbltable/${league}${s?"/"+s:""}?t=${t}`);
}

// Daten holen
async function fetchWithFallback(urls){
  let last=null;
  for(const u of urls){
    try{
      debug("[TRY ] "+u);
      const res=await fetch(u,{cache:"no-store"});
      const txt=await res.text();
      if(!res.ok) throw new Error("HTTP "+res.status+" :: "+txt.slice(0,100));
      const data=JSON.parse(txt);
      if(!Array.isArray(data)) throw new Error("kein Array");
      debug("[OK  ] "+u+" -> "+data.length);
      return data;
    }catch(e){debug("[FAIL] "+u+" :: "+(e?.message||e)); last=e;}
  }
  throw last||new Error("keine Quelle");
}

// Indexe + Matching
function buildIndexes(live){return {exact:new Map(live.map((r,i)=>[r.teamName,i])),byNorm:new Map(live.map((r,i)=>[norm(r.teamName),i]))};}
function compute(live,idx){
  let sumT=0,sumD=0;
  const rows=teamsOfficial.map(team=>{
    let i=idx.exact.get(team);
    if(i==null){const n=norm(team);if(idx.byNorm.has(n)) i=idx.byNorm.get(n);}
    if(i==null){const n=norm(team);if(synonymList[n]){for(const alt of synonymList[n]){const cand=norm(alt);if(idx.byNorm.has(cand)) i=idx.byNorm.get(cand);}}}
    if(i==null){let best=-1,dist=99;const n=norm(team);for(let j=0;j<live.length;j++){const d=lev(n,norm(live[j].teamName));if(d<dist){dist=d;best=j;}}if(dist<=3) i=best;}
    const livePos=i!=null&&i>=0?i+1:null;
    const th=picksThomas[team]??null; const dv=picksDave[team]??null;
    const dT=(livePos&&th)?Math.abs(th-livePos):null;
    const dD=(livePos&&dv)?Math.abs(dv-livePos):null;
    if(dT!=null) sumT+=dT; if(dD!=null) sumD+=dD;
    return {team,live:livePos,thomas:th,dave:dv,diff_thomas:dT,diff_dave:dD,logo:i!=null?live[i].teamIconUrl:""};
  });
  return {rows,sumT,sumD};
}

// Render
function render({rows,sumT,sumD}){
  const tbody=document.querySelector("#table tbody");
  tbody.innerHTML="";
  const sorter=document.getElementById("sorter").value;
  rows.slice().sort((a,b)=>{
    if(sorter==="name") return a.team.localeCompare(b.team);
    return (a[sorter]??99)-(b[sorter]??99);
  }).forEach(r=>{
    tbody.insertAdjacentHTML("beforeend",
      `<tr><td>${r.live??"â€“"}</td><td>${r.team}</td>
       <td>${r.live??"â€“"}</td><td>${r.thomas??"â€“"}</td><td>${chip(r.diff_thomas)}</td>
       <td>${r.dave??"â€“"}</td><td>${chip(r.diff_dave)}</td></tr>`);
  });
  document.getElementById("sum_thomas").textContent=sumT;
  document.getElementById("sum_dave").textContent=sumD;
  document.getElementById("kpi_thomas").textContent=sumT;
  document.getElementById("kpi_dave").textContent=sumD;
  document.getElementById("leader").textContent=(sumT<sumD?"Thomas fÃ¼hrt":sumD<sumT?"Dave fÃ¼hrt":"Gleichstand");
}

// Load
async function load(){
  debug("â€” Reload "+new Date().toLocaleTimeString()+" â€”");
  try{
    const season=document.getElementById("season").value;
    const live=await fetchWithFallback(urlsFor("bl1",season));
    const idx=buildIndexes(live);
    render(compute(live,idx));
  }catch(e){debug("Finaler Fehler: "+(e?.message||e));}
}
document.getElementById("reload").onclick=load;
document.getElementById("season").onchange=load;
document.getElementById("sorter").onchange=load;
load();
</script>
</body>
</html>
