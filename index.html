<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Bundesliga Tippspiel â€“ Online Live-Scorer (Worker-first)</title>
<meta name="description" content="Robuster Live-Scorer fÃ¼r Bundesliga-Tipps mit eigenem Cloudflare-Worker, Debug-Konsole und Saison-Auswahl.">
<style>
  :root { --bg:#0b0f14; --card:#121826; --muted:#94a3b8; --ok:#16a34a; --bad:#ef4444; --accent:#38bdf8; }
  * { box-sizing:border-box; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
  body { margin:0; background:var(--bg); color:#e5e7eb; }
  header { padding:18px 20px; border-bottom:1px solid #1f2937; display:flex; flex-wrap:wrap; gap:12px; align-items:baseline;}
  h1 { margin:0; font-size:1.2rem; }
  .muted { color:var(--muted); }
  main { padding:18px; max-width:1100px; margin:0 auto; }
  .controls { display:flex; flex-wrap:wrap; gap:10px; align-items:center; margin-bottom:12px; }
  select, button { background:#0f172a; color:#e5e7eb; border:1px solid #1f2937; padding:8px 10px; border-radius:10px; }
  button { cursor:pointer; }
  .board { background:var(--card); border:1px solid #1f2937; border-radius:14px; padding:14px; box-shadow:0 6px 24px rgba(0,0,0,.25); }
  table { width:100%; border-collapse:collapse; font-size:14px; }
  thead th { text-align:left; color:#cbd5e1; font-weight:600; border-bottom:1px solid #1f2937; padding:10px 8px; white-space:nowrap; position:sticky; top:0; background:var(--card); z-index:2; }
  tbody td { padding:8px; border-bottom:1px dashed #243244; vertical-align:middle; }
  tbody tr:hover { background: rgba(255,255,255,.03); }
  .rank { width:36px; font-variant-numeric: tabular-nums; }
  .club { display:flex; align-items:center; gap:10px; }
  .club img { width:22px; height:22px; border-radius:50%; background:#111827; }
  .chip { display:inline-block; padding:2px 8px; border-radius:999px; font-variant-numeric:tabular-nums; }
  .good { background:rgba(22,163,74,.15); color:var(--ok); }
  .bad  { background:rgba(239,68,68,.15); color:var(--bad); }
  .exact { border:1px solid var(--ok); }
  .sum { font-weight:700; }
  .kpis { display:flex; gap:12px; margin:12px 0 18px; }
  .kpis > div { background:var(--card); border:1px solid #1f2937; border-radius:12px; padding:10px 12px; }
  .kpiLabel { color:var(--muted); font-size:.85rem; }
  .kpiValue { font-size:1.05rem; color:#fff; }
  .msg { margin:6px 0 12px; }
  footer { color:var(--muted); padding:8px 20px 20px; font-size:.85rem; }
  details { margin-top: 12px; }
  pre { background:#0f172a; border:1px solid #1f2937; border-radius:10px; padding:10px; white-space:pre-wrap; overflow:auto; }
</style>
</head>
<body>
  <header>
    <h1>Bundesliga Tippspiel â€“ Online Live-Scorer</h1>
    <div class="muted">Regel: |Tipp âˆ’ Live-Platz|, Summe = Minuspunkte (weniger ist besser). Einsatz: 1Ã— Polvo-Essen.</div>
  </header>
  <main>
    <div class="controls">
      <label>Saison:
        <select id="season">
          <option value="2025" selected>2025</option>
          <option value="2024">2024</option>
        </select>
      </label>
      <label>Sortieren:
        <select id="sorter">
          <option value="live">Live-Platz</option>
          <option value="thomas">Thomasâ€™ Tipp</option>
          <option value="dave">Daves Tipp</option>
          <option value="diff_thomas">Î” Thomas</option>
          <option value="diff_dave">Î” Dave</option>
          <option value="name">Teamname</option>
        </select>
      </label>
      <button id="reload">Neu laden</button>
    </div>

    <div id="msg" class="msg muted"></div>

    <div class="board">
      <table id="table">
        <thead><tr>
          <th class="rank">#</th>
          <th>Team</th>
          <th>Live</th>
          <th>Thomas</th>
          <th>Î” Thomas</th>
          <th>Dave</th>
          <th>Î” Dave</th>
        </tr></thead>
        <tbody></tbody>
        <tfoot><tr class="sum">
          <td></td><td>Summe Minuspunkte</td>
          <td></td>
          <td id="sum_thomas"></td><td></td>
          <td id="sum_dave"></td><td></td>
        </tr></tfoot>
      </table>
    </div>

    <div class="kpis">
      <div><div class="kpiLabel">Thomas</div><div class="kpiValue" id="kpi_thomas">â€“</div></div>
      <div><div class="kpiLabel">Dave</div><div class="kpiValue" id="kpi_dave">â€“</div></div>
      <div><div class="kpiLabel">FÃ¼hrend</div><div class="kpiValue" id="leader">â€“</div></div>
    </div>

    <details>
      <summary>Debug</summary>
      <div id="debug"></div>
    </details>
  </main>

  <footer>
    <div>Quelle: OpenLigaDB â€“ Ã¼ber deinen Cloudflare-Worker (CORS-sicher). Bei Bedarf Saison wechseln und â€žNeu ladenâ€œ.</div>
  </footer>

<script>
// ðŸ‘‰ HIER deine Worker-URL eintragen (ohne Slash am Ende):
const WORKER = "https://udobrennts.davidwstrassbuger.workers.dev";

// Offizielle Teams
const teamsOfficial = [
  "FC Bayern MÃ¼nchen","Borussia Dortmund","RB Leipzig","VfB Stuttgart",
  "Bayer 04 Leverkusen","Eintracht Frankfurt","1. FSV Mainz 05","1. FC KÃ¶ln",
  "FC Augsburg","SV Werder Bremen","SC Freiburg","Borussia MÃ¶nchengladbach",
  "TSG 1899 Hoffenheim","VfL Wolfsburg","Hamburger SV","1. FC Union Berlin",
  "FC St. Pauli","1. FC Heidenheim 1846"
];

// Tipps (Thomas & Dave)
const picksThomas = {"FC Bayern MÃ¼nchen":1,"Borussia Dortmund":2,"RB Leipzig":3,"VfB Stuttgart":4,"Bayer 04 Leverkusen":5,"Eintracht Frankfurt":6,"1. FSV Mainz 05":7,"1. FC KÃ¶ln":8,"FC Augsburg":9,"SV Werder Bremen":10,"SC Freiburg":11,"Borussia MÃ¶nchengladbach":12,"TSG 1899 Hoffenheim":13,"VfL Wolfsburg":14,"Hamburger SV":15,"1. FC Union Berlin":16,"FC St. Pauli":17,"1. FC Heidenheim 1846":18};
const picksDave   = {"FC Bayern MÃ¼nchen":1,"Eintracht Frankfurt":2,"Borussia Dortmund":3,"VfB Stuttgart":4,"Bayer 04 Leverkusen":5,"RB Leipzig":6,"1. FC KÃ¶ln":7,"1. FSV Mainz 05":8,"SC Freiburg":9,"Hamburger SV":10,"TSG 1899 Hoffenheim":11,"Borussia MÃ¶nchengladbach":12,"FC Augsburg":13,"1. FC Heidenheim 1846":14,"VfL Wolfsburg":15,"FC St. Pauli":16,"1. FC Union Berlin":17,"SV Werder Bremen":18};

// Helper
function debug(line){ const box = document.getElementById("debug"); const el = document.createElement("pre"); el.textContent = line; box.appendChild(el); }
function msg(text, cls="muted"){ const el = document.getElementById("msg"); el.className = "msg " + cls; el.textContent = text; }
function chip(value){ if (value==null) return "<span class='chip bad'>â€“</span>"; const cls = value===0 ? "chip good exact" : "chip " + (value<=2 ? "good" : "bad"); return `<span class="${cls}">${value}</span>`; }

// URL-Kandidat: Worker immer zuerst, danach (nur falls nÃ¶tig) Direkte
function urlsFor(league, season){
  const seasons = [season, "2025", "2024"].filter(v=>v!==undefined);
  const uniq = [...new Set(seasons)];
  const bases = [
    (s) => `${WORKER}/getbltable/${league}${s?"/"+s:""}`
    // Wenn du willst: hier noch direkte Quellen als Backup anhÃ¤ngen
  ];
  const urls = [];
  for (const s of uniq) for (const make of bases) urls.push(make(s));
  return urls;
}

// Fetch mit Fallbacks
async function fetchWithFallback(urls){
  let last=null;
  for (const u of urls){
    try{
      debug(`[TRY ] ${u}`);
      const res = await fetch(u, { cache:"no-store" });
      const txt = await res.text();
      if (!res.ok) throw new Error(`HTTP ${res.status}\n${txt.slice(0,400)}`);
      // WICHTIG: klein geschriebene Keys aus deinem Worker: teamName, teamIconUrl, ...
      const data = JSON.parse(txt);
      const arr = Array.isArray(data) ? data : [];
      debug(`[OK  ] ${u} -> ${arr.length}`);
      return arr;
    }catch(e){ debug(`[FAIL] ${u}\n${e?.message||e}`); last=e; }
  }
  throw last || new Error("Keine Quelle lieferte Daten.");
}

// Mapping + Rendering
function compute(list){
  // list: [{teamName, teamIconUrl, ...}] â€“ Reihenfolge = Rang
  let sumT=0, sumD=0;
  const rows = teamsOfficial.map((team)=>{
    const idx = list.findIndex(r => r.teamName === team);
    const live = idx>=0 ? (idx+1) : null;
    const th = picksThomas[team] ?? null;
    const dv = picksDave[team] ?? null;
    const dT = (live!=null && th!=null) ? Math.abs(th-live) : null;
    const dD = (live!=null && dv!=null) ? Math.abs(dv-live) : null;
    if (dT!=null) sumT += dT;
    if (dD!=null) sumD += dD;
    const logo = idx>=0 ? (list[idx].teamIconUrl || "") : "";
    return { team, live, thomas: th, dave: dv, diff_thomas: dT, diff_dave: dD, logo };
  });
  return { rows, sumT, sumD, canScore: rows.every(r => typeof r.live === "number") };
}

function render(result){
  const { rows, sumT, sumD, canScore } = result;
  const sorter = document.getElementById("sorter").value;
  const tbody = document.querySelector("#table tbody");
  tbody.innerHTML = "";

  const sorted = rows.slice().sort((a,b)=>{
    if (sorter==="name") return a.team.localeCompare(b.team);
    return (a[sorter] ?? 999) - (b[sorter] ?? 999);
  });

  for (const r of sorted){
    const rank = (typeof r.live === "number") ? r.live : "â€“";
    tbody.insertAdjacentHTML("beforeend", `
      <tr>
        <td class="rank">${rank}</td>
        <td class="club"><img src="${r.logo}" alt="" /> ${r.team}</td>
        <td>${rank}</td>
        <td>${r.thomas ?? "â€“"}</td>
        <td>${chip(r.diff_thomas)}</td>
        <td>${r.dave ?? "â€“"}</td>
        <td>${chip(r.diff_dave)}</td>
      </tr>
    `);
  }
  document.getElementById("sum_thomas").textContent = canScore ? sumT : "â€“";
  document.getElementById("sum_dave").textContent   = canScore ? sumD : "â€“";
  document.getElementById("kpi_thomas").textContent = canScore ? sumT : "â€“";
  document.getElementById("kpi_dave").textContent   = canScore ? sumD : "â€“";
  document.getElementById("leader").textContent     = canScore ? ((sumT < sumD) ? "Thomas fÃ¼hrt" : (sumD < sumT) ? "Dave fÃ¼hrt" : "Gleichstand") : "Live nÃ¶tig";
}

// Load
async function load(){
  const season = document.getElementById("season").value;
  msg("Lade Live-Tabelle â€¦");
  document.getElementById("debug").innerHTML = "";
  try{
    const league = "bl1";
    const urls = urlsFor(league, season);
    const data = await fetchWithFallback(urls);        // array mit {teamName, teamIconUrl, ...}
    const result = compute(data);
    render(result);
    msg("Live-Daten geladen.");
  }catch(e){
    msg("Konnte Live-Daten nicht laden â€“ siehe Debug.", "muted");
    render({rows: teamsOfficial.map(t=>({team:t, live:null, thomas:picksThomas[t]??null, dave:picksDave[t]??null, diff_thomas:null, diff_dave:null, logo:""})), sumT:0, sumD:0, canScore:false});
    debug("Finaler Fehler: " + (e?.message || e));
  }
}

document.getElementById("reload").onclick = load;
document.getElementById("season").onchange = load;
document.getElementById("sorter").onchange = load;
load();
</script>
</body>
</html>
